name: Create Branch from Jira (slug + auto PR)

permissions:
  contents: write
  pull-requests: write

on:
  repository_dispatch:
    types: [create-branch]

jobs:
  create_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create sanitized branch name and push
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issue_key }}
          ISSUE_SUMMARY: ${{ github.event.client_payload.issue_summary }}
        run: |
          set -euo pipefail

          echo "Raw issue summary: $ISSUE_SUMMARY"

          RAW="$ISSUE_SUMMARY"

          # 1 — Remover acentos usando iconv
          ASCII=$(printf "%s" "$RAW" | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || true)

          # 2 — Substituir tudo que não for alfanumérico por hífen
          CLEAN=$(printf "%s" "$ASCII" | sed 's/[^a-zA-Z0-9]/-/g')

          # 3 — Lowercase
          CLEAN=$(printf "%s" "$CLEAN" | tr '[:upper:]' '[:lower:]')

          # 4 — Remover hífens duplicados
          CLEAN=$(printf "%s" "$CLEAN" | sed 's/-\+/-/g')

          # 5 — Remover hífen do início e fim
          CLEAN=$(printf "%s" "$CLEAN" | sed 's/^-//' | sed 's/-$//')

          # 6 — Limitar a 50 caracteres
          SLUG=$(printf "%s" "$CLEAN" | cut -c1-50)

          # 7 — Se slug ficar vazio, usar só o key
          if [ -z "$SLUG" ]; then
            BRANCH_NAME="feature/${ISSUE_KEY}"
          else
            BRANCH_NAME="feature/${ISSUE_KEY}-${SLUG}"
          fi

          echo "Branch final: $BRANCH_NAME"

          # Preparar git
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Evitar erro caso branch já exista
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME já existe — saindo (não criaremos branch novamente)."
            # exportar variável para os próximos steps
            echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
            exit 0
          fi

          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

          # exportar variável para próximos steps
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Ensure gh CLI authenticated
        # o runner já tem gh instalado; GITHUB_TOKEN será usado automaticamente pelo gh se setado no env
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh --version

      - name: Create Pull Request automatically (if not exists)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_KEY: ${{ github.event.client_payload.issue_key }}
          ISSUE_SUMMARY: ${{ github.event.client_payload.issue_summary }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        run: |
          set -euo pipefail

          # Branch alvo do PR (mude se quiser outro destino)
          TARGET_BRANCH="main"

          # Título e corpo do PR
          PR_TITLE="${ISSUE_KEY} - ${ISSUE_SUMMARY}"
          
          # Ajuste a URL do Jira para o seu domínio
          JIRA_BASE_URL="https://seudominio.atlassian.net"
          
          PR_BODY=$(cat <<EOF
### Pull Request criado automaticamente

**Issue Jira:** ${JIRA_BASE_URL}/browse/${ISSUE_KEY}  
**Branch:** ${BRANCH_NAME}

Este PR foi gerado automaticamente a partir da movimentação da issue no Jira.
EOF
)

          echo "Verificando se PR já existe para ${BRANCH_NAME}..."

          # Verificar se já existe PR aberto apontando a partir dessa branch
          if gh pr list --head "${BRANCH_NAME}" --json number -q '.[0].number' >/dev/null 2>&1; then
            EXISTING_PR=$(gh pr list --head "${BRANCH_NAME}" --json number -q '.[0].number' || true)
            if [ -n "$EXISTING_PR" ]; then
              echo "Já existe um PR (#${EXISTING_PR}) para a branch ${BRANCH_NAME} — saindo."
              exit 0
            fi
          fi

          echo "Criando PR ${BRANCH_NAME} -> ${TARGET_BRANCH} ..."
          # Criar PR; --assignee, --reviewer, --label podem ser adicionados conforme precisa
          gh pr create \
            --base "${TARGET_BRANCH}" \
            --head "${BRANCH_NAME}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            || echo "Falha ao criar PR (talvez já exista)."

          echo "PR criado (ou já existia)."
