name: Create Branch from Jira (slug + auto PR)

permissions:
  contents: write
  pull-requests: write

on:
  repository_dispatch:
    types: [create-branch]

jobs:
  create_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create sanitized branch name and push
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issue_key }}
          ISSUE_SUMMARY: ${{ github.event.client_payload.issue_summary }}
        run: |
          set -euo pipefail

          echo "Raw issue summary: $ISSUE_SUMMARY"

          RAW="$ISSUE_SUMMARY"

          # 1 — Remover acentos usando iconv
          ASCII=$(printf "%s" "$RAW" | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || true)

          # 2 — Substituir tudo que não for alfanumérico por hífen
          CLEAN=$(printf "%s" "$ASCII" | sed 's/[^a-zA-Z0-9]/-/g')

          # 3 — Lowercase
          CLEAN=$(printf "%s" "$CLEAN" | tr '[:upper:]' '[:lower:]')

          # 4 — Remover hífens duplicados
          CLEAN=$(printf "%s" "$CLEAN" | sed 's/-\+/-/g')

          # 5 — Remover hífen do início e fim
          CLEAN=$(printf "%s" "$CLEAN" | sed 's/^-//' | sed 's/-$//')

          # 6 — Limitar a 50 caracteres
          SLUG=$(printf "%s" "$CLEAN" | cut -c1-50)

          # 7 — Se slug ficar vazio, usar só o key
          if [ -z "$SLUG" ]; then
            BRANCH_NAME="feature/${ISSUE_KEY}"
          else
            BRANCH_NAME="feature/${ISSUE_KEY}-${SLUG}"
          fi

          echo "Branch final: $BRANCH_NAME"

          # Preparar git
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Evitar erro caso branch já exista
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME já existe — saindo (não criaremos branch novamente)."
            # exportar variável para os próximos steps
            echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
            exit 0
          fi

          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

          # exportar variável para próximos steps
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
