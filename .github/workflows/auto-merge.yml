name: Auto Merge Branch From Jira

permissions:
  contents: write
  pull-requests: write

on:
  repository_dispatch:
    types: [merge-branch]

jobs:
  merge_branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect branch to merge
        id: detect
        run: |
          echo "Payload recebido:"
          echo "${{ github.event.client_payload }}"

          ISSUE_KEY="${{ github.event.client_payload.issue_key }}"
          BRANCH_NAME="${{ github.event.client_payload.branch_name }}"

          # Se Jira não mandar branch, vamos procurar
          if [ -z "$BRANCH_NAME" ]; then
            echo "Nenhum branch_name enviado, procurando por issue key..."

            BRANCH_NAME=$(git branch -r | grep "$ISSUE_KEY" | sed 's|origin/||' | head -n 1 || true)
          fi

          if [ -z "$BRANCH_NAME" ]; then
            echo "Nenhuma branch encontrada contendo: $ISSUE_KEY"
            exit 1
          fi

          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "Branch detectada: $BRANCH_NAME"

      - name: Create PR internally
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.BRANCH_NAME;

            // Verificar se já existe PR aberto
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: "main",
              state: "open"
            });

            let pr;
            if (prs.data.length > 0) {
              pr = prs.data[0];
            } else {
              // Criar PR silenciosamente
              pr = (await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: branch,
                base: "main",
                title: `Auto-merge ${branch}`,
                body: "PR criado automaticamente para merge automático."
              })).data;
            }

            core.setOutput("pr_number", pr.number);

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: "squash" // pode trocar para merge ou rebase
            });

            console.log("Merge automático concluído com sucesso!");
